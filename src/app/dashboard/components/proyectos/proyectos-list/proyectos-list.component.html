<div class="dashboard-container">

  <div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="dashboard-title">Proyectos</h1>
        <p class="dashboard-subtitle">
          {{ authService.isAdmin() ? 'Todos los proyectos' : 
             authService.isEncargado() ? 'Proyectos donde eres encargado' : 
             'Proyectos asignados' }}
        </p>
      </div>
      <button 
        *ngIf="authService.isAdmin()"
        [routerLink]="['/dashboard/proyectos/nuevo']"
        class="btn btn-primary d-flex align-items-center shadow-sm">
        <i-feather name="plus" class="feather-sm me-2"></i-feather>
        Nuevo Proyecto
      </button>
    </div>
  </div>

  <!-- Vista para ADMINISTRADOR  -->
  <div *ngIf="authService.isAdmin()" class="projects-card">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title">Lista de Proyectos</h2>
        <div class="text-muted small">
          Mostrando {{ getDisplayRange() }}
        </div>
      </div>
    </div>

    <div class="table-container">
      <table class="projects-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Fecha Límite</th>
            <th>Encargado</th>
            <th>Creado por</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="isLoading">
            <td colspan="6" class="text-center py-5">
              <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
              </div>
            </td>
          </tr>
          
          <tr *ngFor="let proyecto of proyectosPaginados" class="project-row">
            <td>
              <a [routerLink]="['/dashboard/proyectos', proyecto.id]" class="project-name">
                <i-feather name="folder" class="feather-xs me-2"></i-feather>
                {{ proyecto.nombre }}
              </a>
            </td>
            <td>
              <div class="project-description">
                {{ proyecto.descripcion | truncate:60 }}
              </div>
            </td>
            <td>
              <div class="due-date" [class.overdue]="isFechaVencida(proyecto.fechaLimite)">
                <i-feather name="calendar" class="feather-xs me-1"></i-feather>
                {{ proyecto.fechaLimite | date:'dd/MM/yyyy' }}
                <span *ngIf="isFechaVencida(proyecto.fechaLimite)" class="badge bg-danger ms-2">Vencido</span>
              </div>
            </td>
            <td>
              <div class="project-manager">
                <span *ngIf="proyecto.encargadoUsername; else sinEncargado">
                  <i-feather name="user-check" class="feather-xs me-1"></i-feather>
                  {{ proyecto.encargadoUsername }}
                </span>
                <ng-template #sinEncargado>
                  <span class="text-muted">
                    <i-feather name="user-x" class="feather-xs me-1"></i-feather>
                    Sin encargado
                  </span>
                </ng-template>
              </div>
            </td>
            <td>
              <div class="project-creator">
                <i-feather name="user" class="feather-xs me-1"></i-feather>
                {{ proyecto.creadorUsername }}
              </div>
            </td>
            <td class="text-end">
              <div class="actions">
                <button 
                  [routerLink]="['/dashboard/proyectos', proyecto.id]"
                  class="btn-action btn-edit tooltip-container">
                  <i-feather name="edit" class="feather-sm"></i-feather>
                  <span class="tooltip-text">Modificar</span>
                </button>
                <button 
                  *ngIf="authService.isAdmin()"
                  (click)="eliminarProyecto(proyecto.id, proyecto.nombre)"
                  class="btn-action btn-delete tooltip-container">
                  <i-feather name="trash-2" class="feather-sm"></i-feather>
                  <span class="tooltip-text">Eliminar</span>
                </button>
              </div>
            </td>
          </tr>
          
          <tr *ngIf="!isLoading && proyectos.length === 0">
            <td colspan="6" class="text-center py-4">
              <div class="empty-state">
                <i-feather name="folder" class="feather-lg mb-2"></i-feather>
                <p>No se encontraron proyectos</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación  -->
    <div class="card-footer">
      <app-pagination 
        [currentPage]="currentPage"
        [itemsPerPage]="itemsPerPage"
        [totalItems]="proyectos.length"
        (pageChange)="onPageChange($event)">
      </app-pagination>
    </div>
  </div>

  <!-- Vista para ENCARGADO  -->
  <div *ngIf="authService.isEncargado()">
    <div *ngIf="proyectosConTareas.length > 0" class="projects-grid">
      <div *ngFor="let proyecto of proyectosConTareas" class="project-card">
        <div class="project-card-header">
          <h3 class="project-title">
            <a [routerLink]="['/dashboard/proyectos', proyecto.id]">
              {{ proyecto.nombre }}
            </a>
          </h3>
          <div class="project-due-date" [class.overdue]="isFechaVencida(proyecto.fechaLimite)">
            <i-feather name="calendar" class="feather-xs me-1"></i-feather>
            {{ proyecto.fechaLimite | date:'dd/MM/yyyy' }}
            <span *ngIf="isFechaVencida(proyecto.fechaLimite)" class="badge bg-danger ms-2">Vencido</span>
          </div>
        </div>
        
        <p class="project-description">{{ proyecto.descripcion | truncate:120 }}</p>
        
        
        <div class="project-stats-compact">
          <div class="stat-row">
            <div class="stat-box">
              <span class="stat-number">{{ proyecto.tareas?.length || 0 }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-box">
              <span class="stat-number">{{ proyecto.tareasPendientes || 0 }}</span>
              <span class="stat-label">Pendientes</span>
            </div>
            <div class="stat-box">
              <span class="stat-number">{{ proyecto.tareasEnProgreso || 0 }}</span>
              <span class="stat-label">En progreso</span>
            </div>
            <div class="stat-box">
              <span class="stat-number">{{ proyecto.tareasCompletadas || 0 }}</span>
              <span class="stat-label">Completadas</span>
            </div>
          </div>
        </div>
        
        <div class="project-progress">
          <div class="progress-info">
            <span class="progress-label">Progreso</span>
            <span class="progress-percent">
              {{ ((proyecto.tareasCompletadas / proyecto.tareas?.length) * 100 || 0) | number:'1.0-0' }}%
            </span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="(proyecto.tareasCompletadas / proyecto.tareas?.length) * 100 || 0"></div>
          </div>
        </div>
        
        <div class="project-actions">
          <a [routerLink]="['/dashboard/tareas/nueva']" [queryParams]="{proyectoId: proyecto.id}" class="btn btn-primary d-flex align-items-center justify-content-center shadow-sm">
            <i-feather name="plus" class="feather-sm me-2"></i-feather>
            Nueva tarea
          </a>
        </div>
      </div>
    </div>

    <div *ngIf="!isLoading && proyectosConTareas.length === 0" class="empty-state">
      <i-feather name="folder" class="feather-lg mb-2"></i-feather>
      <p>No se encontraron proyectos asignados</p>
    </div>
  </div>
</div>